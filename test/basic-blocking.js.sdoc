Simple blocking queue tests

caterwaul.clone('std', 'queue.blocking')(function () {
  var q = caterwaul.queue.blocking(3, {empty: fn_[empty()]}), callbacks = {}, empty = null;

  q(fn[free_cc][callbacks.first = free_cc]);
  callbacks.first || null['Failed to synchronously invoke the first callback on an empty queue'];

  q(fn[free_cc][callbacks.second = free_cc]);
  callbacks.second || null['Failed to synchronously invoke the second callback'];

  q(fn[free_cc][callbacks.third = free_cc]);
  callbacks.third || null['Failed to synchronously invoke the third callback'];

  q(fn[free_cc][callbacks.fourth = free_cc]);
  callbacks.fourth && null['Failed to block on the fourth'];

  q(fn[free_cc][callbacks.fifth = free_cc]);
  callbacks.fifth && null['Failed to block on the fifth'];

  callbacks.first();
  callbacks.fourth || null['Failed to invoke the fourth after freeing one'];

  callbacks.second();
  callbacks.fifth || null['Failed to invoke the fifth after freeing one'];

  var got_empty = false;
  empty() = got_empty = true;
  callbacks.third();
  callbacks.fourth();
  callbacks.fifth();

  got_empty || null['Failed to trigger the empty listener'];

  var count = 0;
  q(fn_[++count]);
  q(fn_[++count]);
  q(fn_[++count]);

  count === 3 || null['Queue blocking prematurely after being emptied -- only got #{count} of 3 event(s)'];
})();
